---
title: "Data by Commonwealth Election Division"
author: "Hugh Parsonage"
date: "17 July 2017"
output: html_document
---

```{r setup, include=FALSE}
START <- Sys.time()
library(knitr)
data.kable <- function(DT) {
  current_knitr.kable.NA <- options("knitr.kable.NA")
  options(knitr.kable.NA = '...')
  on.exit(options(knitr.kable.NA = current_knitr.kable.NA))
  if (nrow(DT) > 50) {
    middle_row <- as.data.table(matrix(nrow = 1, ncol = ncol(DT)))
    setnames(middle_row, seq_along(middle_row), names(DT))
    DT_topn <- rbind(head(DT),
                     middle_row,
                     tail(DT))
    kable(DT_topn, format.args = list(big.mark = ","))
  } else {
    kable(DT, format.args = list(big.mark = ","))
  }
}
knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(echo = TRUE, 
                      print_chunk = TRUE)
```

```{r loadPackages}
library(readxl)
library(testthat)
library(magrittr)
library(hutils)
library(data.table)
```

```{r Region}
# Allow replacement
Region <- sprintf("%s%s", "C", "ED")
Region_key <- sprintf("%s%s", Region, "_CODE_2016")
```

```{r CED_decoder}
CED_decoder <-
  read_excel("./data-raw/data-packs/Metadata/2016Census_geog_desc_1st_release.xlsx", 
             sheet = "2016_ASGS_Non-ABS_Structures") %>%
  setDT %>%
  .[ASGS_Structure == "CED"] %>%
  setnames("Census_Code_2016", Region_key) %>%
  setnames("Census_Name_2016", "Electoral_division") %>%
  .[, .SD, .SDcols =  c(Region_key, "Electoral_division")]
```

```{r extract_age}
extract_age <- function(variable, orderedFactor = TRUE) {
  out <- 
    variable %>%
    # Prepare:
    gsub("([0-9]{2})_ov", "\\1ov", x = ., perl = TRUE) %>%
    # Extract
    gsub("^.*?_([0-9]+(?:_[0-9]{1,2})?(?:ov)?).*$", "\\1", ., perl = TRUE) %>%
    gsub("_", "-", ., fixed = TRUE) %>%
    gsub("_?ov", "+", ., perl = TRUE)
  if (orderedFactor) {
    out <- factor(out, levels = unique(out), ordered = TRUE)
  }
  out
}

expect_equal(extract_age("Count_home_Census_Nt_0_14_yr", FALSE), "0-14")
expect_equal(extract_age("Age_0_4_yr_P", FALSE), "0-4")
expect_equal(extract_age("Age_psns_att_edu_inst_25_ov_P", FALSE), "25+")
```

```{r strip_age}
strip_age <- function(variable, orderedFactor = FALSE) {
  out <- 
    variable %>%
    # Prepare:
    gsub("([0-9]{2})_ov", "\\1ov", x = ., perl = TRUE) %>%
    # Extract
    gsub("(_[0-9]+(?:_[0-9]{1,2})?(?:ov)?)_yr", "", ., perl = TRUE)
  if (orderedFactor) {
    out <- factor(out, levels = unique(out), ordered = TRUE)
  }
  out
}

expect_equal(strip_age("P_15_19_yr_Marrd_reg_marrge"), "P_Marrd_reg_marrge")
```

### G01

```{r Region__Persons}
assign(paste0(Region, '__Persons'), { 
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv",
        select = c(Region_key, "Tot_P_P")) %>%
  setnames("Tot_P_P", "persons")
})
```

```{r Region__Sex}
assign(paste0(Region, '__Sex'), { 
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv",
        select = c(Region_key, "Tot_P_M", "Tot_P_F")) %>%
  melt.data.table(id.vars = Region_key,
                  variable.name = "Sex",
                  value.name = "persons") %>%
  .[, Sex := gsub("Tot_P_", "", Sex)] %>%
  .[]
})
```

```{r Region__Age}
assign(paste0(Region, '__Age'), {
   fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv") %>%
  .[, .SD, .SDcols = c(Region_key, 
                       grep("^Age_[0-9].*P$", names(.), value = TRUE))] %>%
  melt.data.table(id.vars = Region_key,
                  variable.name = "Age",
                  value.name = "persons") %>%
  .[, Age := extract_age(Age)] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  .[]
})
```

```{r Region__Age_Sex}
assign(paste0(Region, '__Age_Sex'), {
   fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv") %>%
  .[, .SD, .SDcols = c(Region_key, 
                       grep("^Age_[0-9].*[MF]$", names(.), value = TRUE))] %>%
  melt.data.table(id.vars = Region_key,
                  
                  value.name = "persons") %>%
  .[, Age := extract_age(variable)] %>%
  .[, Sex := gsub("^.*([MF])$", "\\1", variable)] %>%
  .[, variable := NULL] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__HomeCensusNight}
assign(paste0(Region, '__HomeCensusNight'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv", 
        select = c(Region_key, "Counted_Census_Night_home_P", "Count_Census_Nt_Ewhere_Aust_P")) %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "persons") %>%
  .[, HomeCensusNight := grepl("home", variable)] %>%
  .[, .SD, .SDcols = c(Region_key, "HomeCensusNight", "persons")] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__HomeCensusNight_Sex}
assign(paste0(Region, '__HomeCensusNight_Sex'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv", 
        select = c(Region_key,
                   "Counted_Census_Night_home_M", "Count_Census_Nt_Ewhere_Aust_M",
                   "Counted_Census_Night_home_F", "Count_Census_Nt_Ewhere_Aust_F")) %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "persons") %>%
  
  .[, HomeCensusNight := grepl("home", variable)] %>%
  .[, Sex := gsub("^.*([MF])$", "\\1", variable, perl = TRUE)] %>%
  .[, .SD, .SDcols = c(Region_key, "HomeCensusNight", "Sex", "persons")] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__IndigenousStatus}
assign(paste0(Region, '__IndigenousStatus'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv", 
        select = c(Region_key,
                   "Tot_P_P",
                   "Indigenous_psns_Aboriginal_P",
                   "Indig_psns_Torres_Strait_Is_P", 
                   "Indig_Bth_Abor_Torres_St_Is_P")) %>%
  .[, non_Indig := Tot_P_P - (Indigenous_psns_Aboriginal_P +
                                Indig_psns_Torres_Strait_Is_P +
                                Indig_Bth_Abor_Torres_St_Is_P)] %>%
  .[, Tot_P_P := NULL] %>%
  .[] %>%
  melt.data.table(id.vars = c(Region_key),
                  value.name = "persons") %>%
  .[, IndigenousStatus := "Non-indigenous"] %>%
  .[variable == "Indigenous_psns_Aboriginal_P",
    IndigenousStatus := "Aboriginal"] %>%
  .[variable == "Indig_Bth_Abor_Torres_St_Is_P",
    IndigenousStatus := "Both Aboriginal & Torres Strait Islander"] %>%
  .[variable == "Indig_psns_Torres_Strait_Is_P",
    IndigenousStatus := "Torres Strait Islander"] %>%
  .[, variable := NULL] %>%
  .[, IndigenousStatus := factor(IndigenousStatus, levels = unique(.$IndigenousStatus), ordered = TRUE)] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  set_cols_last("persons") %>%
  .[]

})
```

```{r Region__BornAust}
assign(paste0(Region, '__BornAust'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv", 
        select = c(Region_key, 
                   "Birthplace_Australia_P",
                   "Birthplace_Elsewhere_P")) %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "persons") %>%
  .[variable == "Birthplace_Australia_P", BornAust := TRUE] %>%
  .[variable == "Birthplace_Elsewhere_P", BornAust := FALSE] %>%
  .[, variable := NULL] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__BornAust_Sex}
assign(paste0(Region, '__BornAust_Sex'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv", 
        select = c(Region_key, 
                   "Birthplace_Australia_F", "Birthplace_Australia_M",
                   "Birthplace_Elsewhere_F", "Birthplace_Elsewhere_M")) %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "persons") %>%
  .[variable %pin% "Birthplace_Australia", BornAust := TRUE] %>%
  .[variable %pin% "Birthplace_Elsewhere", BornAust := FALSE] %>%
  .[variable %pin% "F$", Sex := "F"] %>%
  .[variable %pin% "M$", Sex := "M"] %>%
  .[, variable := NULL] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__OnlyEnglishSpokenHome}
assign(paste0(Region, '__OnlyEnglishSpokenHome'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv", 
        select = c(Region_key, 
                   "Lang_spoken_home_Eng_only_P",
                   "Lang_spoken_home_Oth_Lang_P")) %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "persons") %>%
  .[variable == "Lang_spoken_home_Eng_only_P", OnlyEnglishSpokenHome := TRUE] %>%
  .[variable == "Lang_spoken_home_Oth_Lang_P", OnlyEnglishSpokenHome := FALSE] %>%
  .[, variable := NULL] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__OnlyEnglishSpokenHome_Sex}
assign(paste0(Region, '__OnlyEnglishSpokenHome_Sex'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv", 
        select = c(Region_key, 
                   "Lang_spoken_home_Eng_only_F",
                   "Lang_spoken_home_Eng_only_M",
                   "Lang_spoken_home_Oth_Lang_F",
                   "Lang_spoken_home_Oth_Lang_M")) %>%
  melt.data.table(id.vars = Region_key, 
                  value.name = "persons") %>%
  .[variable %pin% "Lang_spoken_home_Eng_only", OnlyEnglishSpokenHome := TRUE] %>%
  .[variable %pin% "Lang_spoken_home_Oth_Lang", OnlyEnglishSpokenHome := FALSE] %>%
  .[variable %pin% "F$", Sex := "F"] %>%
  .[variable %pin% "M$", Sex := "M"] %>%
  .[, variable := NULL] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__AustCitizen}
assign(paste0(Region, '__AustCitizen'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv",
        select = c(Region_key,
                   "Tot_P_P",
                   "Australian_citizen_P")) %>%
  .[, NAust := Tot_P_P - Australian_citizen_P] %>%
  .[, Tot_P_P := NULL] %>%
  melt.data.table(id.vars = Region_key) %>%
  .[, AustCitizen := TRUE] %>%
  .[variable == "NAust", AustCitizen := FALSE] %>%
  .[, variable := NULL] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  set_cols_last("persons") %>%
  .[]
})
```


```{r Region__AustCitizen_Sex}
assign(paste0(Region, '__AustCitizen_Sex'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv",
        select = c(Region_key,
                   "Tot_P_F",
                   "Australian_citizen_F",
                   "Tot_P_M",
                   "Australian_citizen_M")) %>%
  .[, NAust_F := Tot_P_F - Australian_citizen_F] %>%
  .[, NAust_M := Tot_P_M - Australian_citizen_M] %>%
  .[, Tot_P_F := NULL] %>%
  .[, Tot_P_M := NULL] %>%
  melt.data.table(id.vars = Region_key) %>%
  .[, AustCitizen := TRUE] %>%
  .[variable %pin% "NAust", AustCitizen := FALSE] %>%
  .[variable %pin% "F$", Sex := "F"] %>%
  .[variable %pin% "M$", Sex := "M"] %>%
  .[, variable := NULL] %>%
  setorderv(setdiff(names(.), "persons")) %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__Age_students}
assign(paste0(Region, '__Age_students'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv",
        select = c(Region_key,
                   "Age_psns_att_educ_inst_0_4_P",
                   "Age_psns_att_educ_inst_5_14_P", 
                   "Age_psns_att_edu_inst_15_19_P",
                   "Age_psns_att_edu_inst_20_24_P", 
                   "Age_psns_att_edu_inst_25_ov_P")) %>%
  melt.data.table(id.vars = Region_key,
                  variable.name = "Age",
                  value.name = "students") %>%
  .[, Age := extract_age(Age)] %>%
  .[] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("persons"))) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__Age_Sex_students}
assign(paste0(Region, '__Age_Sex_students'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv",
        select = c(Region_key,
                   "Age_psns_att_educ_inst_0_4_F",
                   "Age_psns_att_educ_inst_0_4_M",
                   "Age_psns_att_educ_inst_5_14_F", 
                   "Age_psns_att_educ_inst_5_14_M", 
                   "Age_psns_att_edu_inst_15_19_F",
                   "Age_psns_att_edu_inst_15_19_M",
                   "Age_psns_att_edu_inst_20_24_F", 
                   "Age_psns_att_edu_inst_20_24_M", 
                   "Age_psns_att_edu_inst_25_ov_F",
                   "Age_psns_att_edu_inst_25_ov_M")) %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "students") %>%
  .[, Age := extract_age(variable)] %>%
  .[variable %pin% "F$", Sex := "F"] %>%
  .[variable %pin% "M$", Sex := "M"] %>%
  .[, variable := NULL] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("persons"))) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__MaxSchoolingCompleted}
assign(paste0(Region, '__MaxSchoolingCompleted'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv") %>%
  .[, .SD, .SDcols = c(Region_key, grep("High_yr_schl_comp_.*_P", names(.), value = TRUE))] %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "persons") %>%
  .[, tmp := "Did not go to school"] %>%
  .[variable != "High_yr_schl_comp_D_n_g_sch_P",
    tmp := paste("Year", gsub("^.*Yr_([0-9]{1,2}).*$", "\\1", variable))] %>%
  .[, MaxSchoolingCompleted := factor(tmp, levels = rev(unique(.$tmp)), ordered = TRUE)] %>%
  .[, variable := NULL] %>%
  .[, tmp := NULL] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("persons"))) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__MaxSchoolingCompleted_Sex}
assign(paste0(Region, '__MaxSchoolingCompleted_Sex'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv") %>%
  .[, .SD, .SDcols = c(Region_key, grep("High_yr_schl_comp_.*_[MF]$", names(.), value = TRUE))] %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "persons") %>%
  .[, tmp := "Did not go to school"] %>%
  .[variable %notin% c("High_yr_schl_comp_D_n_g_sch_F", "High_yr_schl_comp_D_n_g_sch_M"),
    tmp := paste("Year", gsub("^.*Yr_([0-9]{1,2}).*$", "\\1", variable))] %>%
  .[, MaxSchoolingCompleted := factor(tmp, levels = rev(unique(.$tmp)), ordered = TRUE)] %>%
  .[, Sex := gsub("^.*([MF])$", "\\1", variable)] %>%
  .[, variable := NULL] %>%
  .[, tmp := NULL] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("persons"))) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__Dwelling}
fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv", 
      select = c(Region_key,
                 #"Count_psns_occ_priv_dwgs_M",
                 #"Count_psns_occ_priv_dwgs_F", 
                 "Count_psns_occ_priv_dwgs_P", 
                 #"Count_Persons_other_dwgs_M", 
                 #"Count_Persons_other_dwgs_F", 
                 "Count_Persons_other_dwgs_P")) %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "persons") %>%
  .[, Dwelling := "Other"] %>%
  .[variable == "Count_psns_occ_priv_dwgs_P", Dwelling := "Private"] %>%
  .[, variable := NULL] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("persons"))) %>%
  set_cols_last("persons") %>%
  .[]
```

```{r Region__Dwelling_Sex}
fread("./data-raw/data-packs/data/CED/AUST/2016Census_G01_AUS_CED.csv", 
      select = c(Region_key,
                 "Count_psns_occ_priv_dwgs_M",
                 "Count_psns_occ_priv_dwgs_F", 
                 #"Count_psns_occ_priv_dwgs_P", 
                 "Count_Persons_other_dwgs_M", 
                 "Count_Persons_other_dwgs_F")) %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "persons") %>%
  .[, Dwelling := "Other"] %>%
  .[variable %pin% "priv_dwgs", Dwelling := "Private"] %>%
  .[, Sex := gsub("^.*([MF])$", "\\1", variable)] %>%
  .[, variable := NULL] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("persons"))) %>%
  set_cols_last("persons") %>%
  .[]
```

### G03

```{r Region__UsualResidence_Age}
assign(paste0(Region, '__UsualResidence_Age'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G03_AUS_CED.csv") %>%
  melt.data.table(id.vars = Region_key,
                  variable.factor = FALSE,
                  value.name = "persons") %>%
  .[!(variable %pin% "Tot")] %>%
  .[variable %pin% "(yr|85ov)$"] %>%
  .[, Age := extract_age(variable)] %>%
  .[, ResidenceVar := gsub("_([0-9]+(?:_[0-9]{2})?(?:ov)?)(?:_yr)?$", "", variable, perl = TRUE)] %>%

  .[ResidenceVar %pin% "Count_home?_Census_Nt",
    UsualResidence := "Home"] %>%

  .[ResidenceVar %pin% "VisDiff_SA2_",
    UsualResidence := paste("Visitor from", gsub("VisDiff_SA2_", "", ResidenceVar))] %>%
  .[ResidenceVar %pin% "VisSame",
    UsualResidence := "Visitor same SA2"] %>%
  .[, .SD, .SDcols = c(Region_key, "Age", "UsualResidence", "persons")] %>%
  setkeyv(c(Region_key, "Age", "UsualResidence")) %>%
  .[]
})
```

### G04

```{r Region__minAge}
assign(paste0(Region, '__minAge'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G04A_AUS_CED.csv") %>% 
  merge(fread("./data-raw/data-packs/data/CED/AUST/2016Census_G04B_AUS_CED.csv"),
        by = Region_key) %>%
  .[, .SD, .SDcols = c(Region_key,
                       grep("yr_[0-9]{1,3}_(over_)?P$", names(.), value = TRUE),
                       "Age_yr_80_84_P",
                       "Age_yr_85_89_P",
                       "Age_yr_90_94_P",
                       "Age_yr_95_99_P",
                       "Age_yr_100_yr_over_P")] %>%
  melt.data.table(id.vars = Region_key,
                  variable.name = "minAge",
                  variable.factor = FALSE,
                  value.name = "persons") %>%
  .[, minAge := as.integer(gsub("Age_yr_([0-9]{1,3}).*P$", "\\1", minAge))] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("persons"))) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__minAge_Sex}
assign(paste0(Region, '__minAge_Sex'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G04A_AUS_CED.csv") %>% 
  merge(fread("./data-raw/data-packs/data/CED/AUST/2016Census_G04B_AUS_CED.csv"),
        by = Region_key) %>%
  .[, .SD, .SDcols = c(Region_key,
                       grep("yr_[0-9]{1,3}_(over_)?[MF]$", names(.), value = TRUE),
                       "Age_yr_80_84_F",
                       "Age_yr_80_84_M",
                       "Age_yr_85_89_F",
                       "Age_yr_90_94_M",
                       "Age_yr_95_99_F",
                       "Age_yr_95_99_M",
                       "Age_yr_100_yr_over_F",
                       "Age_yr_100_yr_over_M")] %>%
  melt.data.table(id.vars = Region_key,
                  variable.name = "variable",
                  variable.factor = FALSE,
                  value.name = "persons") %>%
  .[, minAge := as.integer(gsub("Age_yr_([0-9]{1,3}).*[MF]$", "\\1", variable))] %>%
  .[, Sex := gsub("Age_yr_(?:[0-9]{1,3}).*([MF])$", "\\1", variable, perl = TRUE)] %>%
  .[, variable := NULL] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("persons"))) %>%
  set_cols_last("persons") %>%
  .[]
})
```

```{r Region__Age_MaritalStatus_Sex}
assign(paste0(Region, '__Age_MaritalStatus_Sex'), {
  fread("./data-raw/data-packs/data/CED/AUST/2016Census_G05_AUS_CED.csv") %>% 
  .[,
    .SD,
    .SDcols = c(Region_key,
                grep("[MF]_[0-9]{2}(ov)?(_[0-9]{2}_yr)?_(Married|Separated|Divorced|Widowed)", names(.), value = TRUE))] %>%
  melt.data.table(id.vars = Region_key,
                  variable.factor = FALSE,
                  value.name = "persons") %>%
  .[, Age := extract_age(variable)] %>%
  .[, Sex := gsub("^([MF]).*$", "\\1", variable)] %>%
  .[, MaritalStatus := gsub("^.*(Married|Separated|Divorced|Widowed).*$", "\\1", variable, perl = TRUE)] %>%
  .[, variable := NULL] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("persons"))) %>%
  set_cols_last("persons") %>%
  .[]

})
```

```{r Region__MaritalStatus_Age}
fread("./data-raw/data-packs/data/CED/AUST/2016Census_G06_AUS_CED.csv") %>%
  .[, .SD, .SDcols = c(Region_key,
                       names(.)[grepl("^P", names(.)) & !grepl("Tot", names(.))])] %>%
  melt.data.table(id.vars = Region_key,
                  value.name = "adults") %>%
  .[, Age := extract_age(variable)] %>%
  .[, MaritalStatus := gsub("^.*(Marrd_reg_marrge|Married_de_facto|Not_married).*$", "\\1", variable)] %>%
  .[, MaritalStatus := gsub("_", " ", MaritalStatus)] %>%
  .[MaritalStatus == "Marrd reg marrge", Registered := TRUE] %>%
  .[MaritalStatus %pin% "de facto", Registered := FALSE] %>%
  .[MaritalStatus != "Not married", MaritalStatus := "Married"] %>%
  .[, variable := NULL] %>%
  setcolorder(sort(names(.))) %>%
  set_cols_first(Region_key) %>%
  setorderv(setdiff(names(.), c("adults"))) %>%
  set_cols_last("adults") %>%
  .[]
  
```

```{r}
fread("./data-raw/data-packs/data/CED/AUST/2016Census_G07_AUS_CED.csv") %>%
  .[, .SD, .SDcols = c(Region_key,
                       names(.)[nor(grepl("[MF]$", names(.)),
                                    grepl("Tot", names(.)))])]
```

```{r}
FINISH <- Sys.time()
```

```{r use_data, eval=dir.exists("data")}
# Print side-effect ok
stopifnot(dir.exists("data"))
ced_tbls <- tables()$NAME
for (tbl in ced_tbls) {
  save(list = tbl, file = file.path("data", paste0(tbl, ".rda")))
}
```
